<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ESP32 Multical21</title>
  <script src="./form.js"></script>
  <link rel="stylesheet" href="./index.css">
</head>

<body onload="onLoad()">
<main class="app">
<section class="panel">
<h1>ESP32 Multical21</h1>
<p>Firmware version {{ crate::FW_VERSION }} | Hardware {{ crate::HW_TARGET }}</p>
<p>OTA slot {{ askama::get_value::<String>("ota_slot")? }}</p>
<div id="uptime">- - -</div>
</section>
<section class="panel">
<h2>Meter Reading</h2>
<div id="meter">- - -</div>
</section>
<section class="panel">
<h2>Settings</h2>
{% let myform = [
                    ("text", "wifi_ssid", wifi_ssid.to_string(), "WiFi SSID"),
                    ("checkbox", "wifi_wpa2ent", wifi_wpa2ent.to_string(), "WPA2 Enterprise"),
                    ("text", "wifi_username", wifi_username.to_string(), "WiFi username"),
                    ("password", "wifi_pass", wifi_pass.to_string(), "WiFi password"),
                    ("checkbox", "v4dhcp", v4dhcp.to_string(), "DHCP enabled"),
                    ("text", "v4addr", v4addr.to_string(), "IPv4 address"),
                    ("text", "v4mask", v4mask.to_string(), "IPv4 mask length (0-30)"),
                    ("text", "v4gw", v4gw.to_string(), "IPv4 gateway"),
                    ("text", "dns1", dns1.to_string(), "DNS 1"),
                    ("text", "dns2", dns2.to_string(), "DNS 2"),
                    ("checkbox", "esphome_enable", esphome_enable.to_string(), "ESPHome API enabled"),
                    ("checkbox", "mqtt_enable", mqtt_enable.to_string(), "MQTT enabled"),
                    ("text", "mqtt_url", mqtt_url.to_string(), "MQTT URL"),
                    ("text", "mqtt_topic", mqtt_topic.to_string(), "MQTT topic"),
                    ("text", "meter_id", meter_id.to_string(), "Meter ID (8 chars)"),
                    ("password", "meter_key", meter_key.to_string(), "Meter Key (32 hex chars, 16 bytes)")
                ] -%}
<form action="/conf" method="POST" name="esp32cfg">
    <table>
{%- for (itype, name, value, descr) in myform %}
        <tr>
{%- if *itype == "checkbox" %}
            <th><label for="{{name}}">{{descr}}:</label></th>
            <th><input name="{{name}}" type="{{itype}}"{% if value == "true" %} checked{% endif %}></th>
{%- else %}
            <th><label for="{{name}}">{{descr}}:</label></th>
            <th><input name="{{name}}" type="{{itype}}" value="{{value}}"></th>
{%- endif %}
        </tr>
{%- endfor %}
    </table>
    <input type="submit" value="Submit">
</form>
</section>
<section class="panel danger">
<hr>
<h2>Update firmware (DANGER)</h2>
<form action="/fw" method="POST" name="esp32fw">
    <input type="text" id="firmware" name="url">
    <input type="submit" value="Update!">
</form>
</section>
</main>
</body>
</html>
